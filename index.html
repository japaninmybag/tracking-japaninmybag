<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tracking & Admin</title>
<style>
  body{font-family:Inter,sans-serif;margin:0;padding:0;background:#f0f2f8;color:#333;}
  header{display:flex;justify-content:flex-end;padding:20px 40px;background:#fff;box-shadow:0 5px 15px rgba(0,0,0,0.05);}
  .login-btn{background:linear-gradient(135deg,#c8102e,#e63946);color:#fff;border:none;padding:10px 20px;border-radius:12px;font-weight:600;font-size:14px;cursor:pointer;transition:0.3s;position:relative;z-index:10;}
  .login-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(200,16,46,0.4);}
  .container{max-width:900px;margin:50px auto;text-align:center;padding:0 20px;}
  .logo{max-width:160px;margin-bottom:25px;display:block;margin-left:auto;margin-right:auto;}
  .title{font-size:32px;font-weight:700;color:#c8102e;margin-bottom:30px;}
  .search-box{display:flex;gap:15px;margin-bottom:40px;}
  .search-box input{flex:1;padding:15px 20px;border-radius:15px;border:2px solid #0047ab;font-size:16px;transition:0.3s;}
  .search-box input:focus{outline:none;border-color:#c8102e;box-shadow:0 0 10px rgba(200,16,46,0.3);}
  .search-btn{background:linear-gradient(135deg,#c8102e,#e63946);color:#fff;border:none;padding:15px 25px;border-radius:15px;font-weight:600;font-size:16px;cursor:pointer;transition:0.3s;}
  .search-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(200,16,46,0.4);}
  .result-table{width:100%;border-collapse:collapse;margin-top:20px;}
  .result-table th,.result-table td{border:1px solid #ccc;padding:8px;text-align:center;vertical-align:middle;font-size:13px;}
  .result-table th{background:#0047ab;color:#fff;}
  .result-table td img{max-width:80px;max-height:80px;display:block;margin:5px auto; cursor:pointer;}
  form input, form select, form button{margin-bottom:12px;padding:12px 15px;font-size:14px;border-radius:10px;border:1px solid #ccc;}
  form button{background:linear-gradient(135deg,#c8102e,#e63946);color:#fff;border:none;cursor:pointer;font-weight:600;}
  form button:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(200,16,46,0.4);}
  .admin-page{display:none;max-width:1100px;margin:50px auto;padding:20px;background:#fff;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1);text-align:left;}
  #loginModal{display:none;position:absolute;top:60px;right:40px;width:250px;background:#fff;border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.2);padding:20px;z-index:20;}
  #loginModal h2{color:#c8102e;margin-bottom:15px;font-size:18px;}
  #loginModal input{width:100%;margin-bottom:10px;padding:10px;border-radius:8px;border:1px solid #ccc;}
  #loginModal button{width:100%;padding:10px;border-radius:10px;font-weight:600;font-size:14px;}
  .admin-actions{display:flex;gap:10px;align-items:center;margin-bottom:12px;}
  .small-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;}
  .cancel-btn{background:#ccc;color:#111;}

  /* เพิ่มเติม: จัดฟอร์มให้สวยขึ้นและ badge สีสถานะ */
  .admin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;align-items:end;}
  .admin-grid label{font-size:12px;color:#555;margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .status-badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #bbb;background:#f6f6f6;}
  .status-cancel{background:#ffe9ea;border-color:#c8102e;color:#c8102e;font-weight:700;}
  .status-done{background:#e9f7ee;border-color:#1b8e3e;color:#1b8e3e;font-weight:700;}

  /* Lightbox for admin-uploaded images */
  #imgModal{display:none;position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;z-index:1000;}
  #imgModal img{max-width:95vw;max-height:95vh;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.4);}
  #imgModal .close{position:absolute;top:18px;right:24px;border:none;background:rgba(0,0,0,0.6);color:#fff;width:40px;height:40px;border-radius:999px;font-size:24px;line-height:40px;cursor:pointer;}
</style>
</head>
<body>
<header>
  <button class="login-btn" id="openAdmin">Admin Log in</button>
</header>

<main class="container" id="trackingPage">
  <!-- Logo: ถ้าไม่ขึ้นบน GitHub Pages ให้ตรวจสอบ 1) ว่าไฟล์ images/logo.png ถูกอัปโหลดจริงใน repo (case-sensitive) 2) ถ้าใช้ GitHub Pages แบบ root อาจต้องใช้ path /images/logo.png หรือ วาง logo.png ไว้ที่ root แล้วแก้ src ให้ตรง 3) สามารถเปลี่ยน src เป็น './logo.png' หรือ '/images/logo.png' ขึ้นกับโครงสร้าง repo ของคุณ -->
  <img src="logo.png" alt="Logo" id="logoImage" class="logo" onerror="this.onerror=null; this.src='logo-fallback.png'; document.getElementById('logoNote').style.display='block';">
  <div id="logoNote" style="display:none;color:#666;font-size:13px;text-align:center;margin-bottom:10px;">
    ถ้าโลโก้ไม่ขึ้น: ให้อัปโหลดไฟล์ images/logo.png ใน repository (ตรวจสอบตัวพิมพ์ใหญ่/เล็ก และ path) หรือเปลี่ยน src ให้ตรงกับที่เก็บไฟล์บน GitHub.
  </div>

  <h2 class="title">ติดตามสถานะสินค้า</h2>

  <div class="search-box">
    <input type="text" placeholder="กรอกเบอร์โทร หรือ ชื่อนามสกุล" id="searchInput">
    <button class="search-btn" id="searchBtn">ค้นหา</button>
  </div>

  <div id="result"></div>
</main>

<!-- Admin Page -->
<main class="admin-page" id="adminPage">
  <h2 style="color:#c8102e;">Admin Dashboard</h2>

  <div class="admin-actions">
    <button class="small-btn" id="btnAddNew">เพิ่มออร์เดอร์ใหม่</button>
    <!-- ลบปุ่มลบข้อมูลทั้งหมดตามที่ร้องขอ -->
  </div>

  <form id="orderForm">
    <div class="admin-grid">
      <div>
        <label>ชื่อสินค้า</label>
        <input type="text" id="adminProduct" placeholder="ชื่อสินค้า" required>
      </div>
      <div>
        <label>ชื่อ-นามสกุล</label>
        <input type="text" id="adminName" placeholder="ชื่อ-นามสกุล" required>
      </div>
      <div>
        <label>เบอร์โทร</label>
        <input type="text" id="adminPhone" placeholder="เบอร์โทร" required>
      </div>

      <!-- เอาเลขวันที่ 1-5 ออก เหลือคำอธิบายสั้น ๆ และจัดเรียง grid -->
      <div>
        <label>วันที่สั่งสินค้า</label>
        <input type="date" id="adminOrderDate" required>
      </div>
      <div>
        <label>วันที่จ่ายมัดจำ</label>
        <input type="date" id="adminDepositDate" required>
      </div>
      <div>
        <label>วันที่จ่ายมัดจำ (งวดที่ 2)</label>
        <input type="date" id="adminDepositDate2" required>
      </div>
      <div>
        <label>วันที่บินไป</label>
        <input type="date" id="adminFlightOutDate" required>
      </div>
      <div>
        <label>วันที่บินกลับ</label>
        <input type="date" id="adminFlightBackDate" required>
      </div>

      <div>
        <label>สถานะ</label>
        <select id="adminStatus" required>
          <option value="">--สถานะ--</option>
          <option value="สั่งซื้อสินค้า">สั่งซื้อสินค้า</option>
          <option value="ชำระค่ามัดจำ">ชำระค่ามัดจำ</option>
          <option value="ถึงญี่ปุ่น">ถึงญี่ปุ่น</option>
          <option value="กำลังซื้อของ">กำลังซื้อของ</option>
          <option value="ได้สินค้าของคุณแล้ว">ได้สินค้าของคุณแล้ว</option>
          <option value="เดินทางกลับไทย">เดินทางกลับไทย</option>
          <option value="ถึงไทย">ถึงไทย</option>
          <option value="ส่งของแล้ว">ส่งของแล้ว</option>
          <option value="ดำเนินการเรียบร้อย">ดำเนินการเรียบร้อย</option>
          <option value="ยกเลิก">ยกเลิก</option>
        </select>
      </div>

      <div>
        <label>ราคารวม (เยน)</label>
        <input type="number" id="adminPriceYen" placeholder="ราคารวม (เยน)" required>
      </div>
      <div>
        <label>ราคารวม (บาท)</label>
        <input type="number" id="adminPriceTHB" placeholder="ราคารวม (บาท)" required>
      </div>
      <div>
        <label>รูปสินค้า (ไม่บังคับ)</label>
        <input type="file" id="adminImage" accept="image/*">
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:6px;">
      <button type="submit" id="saveBtn">เพิ่มข้อมูลออร์เดอร์</button>
      <button type="button" id="cancelEditBtn" class="cancel-btn" style="display:none;">ยกเลิกแก้ไข</button>
    </div>
  </form>

  <h3 style="margin-top:20px;color:#333;">รายการออร์เดอร์ (Admin)</h3>
  <div id="adminOrdersList"></div>
</main>

<!-- Login Modal -->
<div id="loginModal">
  <h2>Admin Login</h2>
  <form id="loginForm">
    <input type="text" id="loginUser" placeholder="ชื่อผู้ใช้" required>
    <input type="password" id="loginPass" placeholder="รหัสผ่าน" required>
    <button type="submit">Log in</button>
  </form>
</div>

<script>
let orders = JSON.parse(localStorage.getItem('orders') || '[]');
let editingIndex = -1;

const openAdminBtn = document.getElementById("openAdmin");
const loginModal = document.getElementById("loginModal");
openAdminBtn.addEventListener("click", ()=>loginModal.style.display="block");

// Login
document.getElementById("loginForm").addEventListener("submit", function(e){
  e.preventDefault();
  const user = document.getElementById("loginUser").value.trim();
  const pass = document.getElementById("loginPass").value;
  if(user==="japaninmybag" && pass==="jpimb224"){
    alert("เข้าสู่ระบบ Admin สำเร็จ!");
    loginModal.style.display="none";
    document.getElementById("trackingPage").style.display="none";
    document.getElementById("adminPage").style.display="block";
    renderAdminOrders();
  } else alert("ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง");
});

// ฟังก์ชันเก็บ/อัปเดต localStorage
function saveOrders(){
  localStorage.setItem('orders', JSON.stringify(orders));
  renderAdminOrders();
}

// เพิ่ม/อัปเดตออร์เดอร์
document.getElementById("orderForm").addEventListener("submit", function(e){
  e.preventDefault();
  const fileInput = document.getElementById("adminImage");
  const reader = new FileReader();

  const collectAndSave = (imgData)=>{
    const dataObj = {
      product: document.getElementById("adminProduct").value,
      name: document.getElementById("adminName").value,
      phone: document.getElementById("adminPhone").value,
      // วันที่
      orderDate: document.getElementById("adminOrderDate").value,
      depositDate: document.getElementById("adminDepositDate").value,
      depositDate2: document.getElementById("adminDepositDate2").value,
      flightOutDate: document.getElementById("adminFlightOutDate").value,
      flightBackDate: document.getElementById("adminFlightBackDate").value,
      status: document.getElementById("adminStatus").value,
      priceYen: Number(document.getElementById("adminPriceYen").value) || 0,
      priceTHB: Number(document.getElementById("adminPriceTHB").value) || 0,
      img: imgData || null,
      createdAt: new Date().toISOString()
    };

    if(editingIndex >= 0){
      orders[editingIndex] = {...orders[editingIndex], ...dataObj};
      editingIndex = -1;
      document.getElementById("saveBtn").textContent = "เพิ่มข้อมูลออร์เดอร์";
      document.getElementById("cancelEditBtn").style.display = "none";
      alert("แก้ไขข้อมูลสำเร็จ!");
    } else {
      orders.push(dataObj);
      alert("เพิ่มข้อมูลสำเร็จ!");
    }
    saveOrders();
    document.getElementById("orderForm").reset();
  };

  if(fileInput.files[0]){
    reader.onload = function(){ collectAndSave(reader.result); };
    reader.readAsDataURL(fileInput.files[0]);
  } else {
    collectAndSave(null);
  }
});

// ฟังก์ชันทำ badge สีสถานะ (ยกเลิก=แดง / ส่งเรียบร้อย=เขียว)
function statusBadge(s){
  if(!s) return '-';
  const isCancel = /ยกเลิก/.test(s);
  const isDone = /(ส่ง|เรียบร้อย)/.test(s); // ครอบคลุม "ส่งเรียบร้อย", "ส่งของแล้ว", "ดำเนินการเรียบร้อย"
  if(isCancel) return `<span class="status-badge status-cancel">${s}</span>`;
  if(isDone) return `<span class="status-badge status-done">${s}</span>`;
  return `<span class="status-badge">${s}</span>`;
}

// render หน้า Admin list (มี Edit / Delete)
function renderAdminOrders(){
  const container = document.getElementById("adminOrdersList");
  if(!orders.length){
    container.innerHTML = "<p style='color:#666;'>ไม่มีออร์เดอร์</p>";
    return;
  }
  container.innerHTML = `
    <table class="result-table">
      <tr>
        <th>#</th><th>สินค้า</th><th>ชื่อนามสกุล</th><th>โทร</th>
        <th>วันที่สั่ง</th><th>วันที่จ่ายมัดจำ1</th><th>วันที่จ่ายมัดจำ2</th>
        <th>วันที่บินไป</th><th>วันที่บินกลับ</th>
        <th>สถานะ</th><th>เยน</th><th>บาท</th><th>รูป</th><th>จัดการ</th>
      </tr>
      ${orders.map((o,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${o.product||''}</td>
          <td>${o.name||''}</td>
          <td>${o.phone||''}</td>
          <td>${o.orderDate||'-'}</td>
          <td>${o.depositDate||'-'}</td>
          <td>${o.depositDate2||'-'}</td>
          <td>${o.flightOutDate||'-'}</td>
          <td>${o.flightBackDate||'-'}</td>
          <td>${statusBadge(o.status||'-')}</td>
          <td>${o.priceYen?Number(o.priceYen).toLocaleString():'-'}</td>
          <td>${o.priceTHB?Number(o.priceTHB).toLocaleString():'-'}</td>
          <td>${o.img?`<img src="${o.img}" style="max-width:60px;max-height:60px;">`:'-'}</td>
          <td>
            <button onclick="editOrder(${i})" class="small-btn">แก้ไข</button>
            <button onclick="deleteOrder(${i})" class="small-btn cancel-btn">ลบ</button>
          </td>
        </tr>
      `).join('')}
    </table>
  `;
}

// Edit
window.editOrder = function(index){
  const o = orders[index];
  editingIndex = index;
  document.getElementById("adminProduct").value = o.product || '';
  document.getElementById("adminName").value = o.name || '';
  document.getElementById("adminPhone").value = o.phone || '';
  document.getElementById("adminOrderDate").value = o.orderDate || '';
  document.getElementById("adminDepositDate").value = o.depositDate || '';
  document.getElementById("adminDepositDate2").value = o.depositDate2 || '';
  document.getElementById("adminFlightOutDate").value = o.flightOutDate || '';
  document.getElementById("adminFlightBackDate").value = o.flightBackDate || '';
  document.getElementById("adminStatus").value = o.status || '';
  document.getElementById("adminPriceYen").value = o.priceYen || '';
  document.getElementById("adminPriceTHB").value = o.priceTHB || '';
  document.getElementById("saveBtn").textContent = "บันทึกการแก้ไข";
  document.getElementById("cancelEditBtn").style.display = "inline-block";
  window.scrollTo({top:0,behavior:'smooth'});
};

// Cancel edit
document.getElementById("cancelEditBtn").addEventListener("click", ()=>{
  editingIndex = -1;
  document.getElementById("orderForm").reset();
  document.getElementById("saveBtn").textContent = "เพิ่มข้อมูลออร์เดอร์";
  document.getElementById("cancelEditBtn").style.display = "none";
});

// Delete
window.deleteOrder = function(index){
  if(confirm("ยืนยันการลบออร์เดอร์?")){
    orders.splice(index,1);
    saveOrders();
  }
};

// ปุ่มเพิ่มใหม่: รีเซ็ตฟอร์ม
document.getElementById("btnAddNew").addEventListener("click", ()=>{
  editingIndex = -1;
  document.getElementById("orderForm").reset();
  document.getElementById("saveBtn").textContent = "เพิ่มข้อมูลออร์เดอร์";
  document.getElementById("cancelEditBtn").style.display = "none";
});

// ค้นหา (หน้าผู้ใช้)
document.getElementById("searchBtn").addEventListener("click", runSearch);
document.getElementById("searchInput").addEventListener("keyup", function(e){
  if(e.key === "Enter") runSearch();
});

function runSearch(){
  const input = document.getElementById("searchInput").value.trim();
  const resultDiv = document.getElementById("result");
  if(!input){ resultDiv.innerHTML=""; return; }
  const found = orders.filter(o=>{
    return (o.phone && o.phone.includes(input)) || (o.name && o.name.includes(input));
  });
  if(found.length){
    resultDiv.innerHTML = `
      <table class="result-table">
        <tr>
          <th>ชื่อสินค้า</th><th>ชื่อนามสกุล</th><th>เบอร์โทร</th>
          <th>วันที่สั่ง</th><th>วันที่จ่ายมัดจำ1</th><th>วันที่จ่ายมัดจำ2</th>
          <th>วันที่บินไป</th><th>วันที่บินกลับ</th>
          <th>สถานะ</th><th>ราคารวม(เยน)</th><th>ราคารวม(บาท)</th><th>รูป</th>
        </tr>
        ${found.map(o=>`
          <tr>
            <td>${o.product||'-'}</td>
            <td>${o.name||'-'}</td>
            <td>${o.phone||'-'}</td>
            <td>${o.orderDate||'-'}</td>
            <td>${o.depositDate||'-'}</td>
            <td>${o.depositDate2||'-'}</td>
            <td>${o.flightOutDate||'-'}</td>
            <td>${o.flightBackDate||'-'}</td>
            <td>${statusBadge(o.status||'-')}</td>
            <td>${o.priceYen?Number(o.priceYen).toLocaleString():'-'}</td>
            <td>${o.priceTHB?Number(o.priceTHB).toLocaleString():'-'}</td>
            <td>${o.img?`<img src="${o.img}">`:'-'}</td>
          </tr>
        `).join('')}
      </table>
    `;
  } else {
    resultDiv.innerHTML = `<p style="color:red;font-weight:600;margin-top:20px;">ไม่พบข้อมูล</p>`;
  }
}

// ตอนโหลดหน้า ถ้ามี logo path ต่างกัน ให้ลองเปลี่ยนอัตโนมัติ (ถ้าใช้ GH Pages บางกรณีต้อง /repo-name/images/...)
(function tryFixLogoForGitHub(){
  const img = document.getElementById('logoImage');
  img.addEventListener('error', ()=>{
    if(img.src.includes('logo-fallback.png')) return;
    const alt1 = '/images/logo.png';
    const alt2 = 'logo.png';
    const alt3 = './images/logo.png';
    const tries = [alt1, alt2, alt3];
    for(const p of tries){
      if(img.src.endsWith(p)) continue;
      img.src = p;
      break;
    }
  });
})();

// render admin list ถ้ามาเปิดหน้า admin แล้ว
if(document.getElementById("adminPage").style.display !== "none"){
  renderAdminOrders();
}

/* ====== LIGHTBOX FEATURE (กดรูปแล้วขยายเต็มจอ + ปุ่มกากบาทปิด) ====== */
(function initImageLightbox(){
  // Create modal container
  const modal = document.createElement('div');
  modal.id = 'imgModal';
  modal.innerHTML = '<button class="close" id="imgClose" aria-label="Close image">×</button><img id="imgModalContent" alt="">';
  document.body.appendChild(modal);

  const modalImg = document.getElementById('imgModalContent');
  const btnClose = document.getElementById('imgClose');

  function openModal(src){
    modalImg.src = src;
    modal.style.display = 'flex';
  }
  function closeModal(){
    modal.style.display = 'none';
    modalImg.src = '';
  }

  // Delegate click: only images inside .result-table (admin & user sections)
  document.addEventListener('click', function(e){
    const t = e.target;
    if(t && t.tagName === 'IMG' && t.closest('.result-table')){
      openModal(t.getAttribute('src'));
    }
  });

  // Close on background click
  modal.addEventListener('click', function(e){
    if(e.target === modal){ closeModal(); }
  });

  // Close on X
  btnClose.addEventListener('click', closeModal);

  // Close on ESC
  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape') closeModal();
  });
})();
</script>
</body>
</html>
